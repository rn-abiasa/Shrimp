<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ü¶ê ShrimpScam | Rich List</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
      };
    </script>
    <script>
      // On page load or when changing themes, best to add inline in `head` to avoid FOUC
      if (
        localStorage.theme === "dark" ||
        (!("theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      body {
        font-family: "Space Grotesk", sans-serif;
      }
      .hash {
        font-family: monospace;
      }
      html {
        scroll-behavior: smooth;
      }
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #09090b;
      }
      ::-webkit-scrollbar-thumb {
        background: #27272a;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #3f3f46;
      }

      /* Tooltip */
      .copy-tooltip {
        position: absolute;
        bottom: 110%;
        left: 50%;
        transform: translateX(-50%);
        padding: 4px 8px;
        background: #22c55e;
        color: white;
        font-size: 10px;
        border-radius: 4px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        white-space: nowrap;
      }
      .copy-btn.copied .copy-tooltip {
        opacity: 1;
      }
    </style>
  </head>
  <body
    class="bg-zinc-50 dark:bg-black text-zinc-600 dark:text-zinc-300 min-h-screen selection:bg-cyan-500/30 selection:text-cyan-800 dark:selection:text-cyan-200 transition-colors duration-300"
  >
    <div class="container mx-auto px-4 py-8 max-w-7xl">
      <!-- Header -->
      <header
        class="flex flex-col md:flex-row justify-between items-center mb-8 border-b border-zinc-200 dark:border-zinc-900 pb-8 transition-colors"
      >
        <div
          class="flex items-center gap-4 mb-4 md:mb-0 cursor-pointer"
          onclick="resetView()"
        >
          <div
            class="w-12 h-12 bg-white dark:bg-zinc-900 rounded-xl flex items-center justify-center border border-zinc-200 dark:border-zinc-800 shadow-[0_0_15px_rgba(6,182,212,0.15)] group transition-colors"
          >
            <span class="text-3xl group-hover:scale-110 transition-transform"
              >ü¶ê</span
            >
          </div>
          <div>
            <h1
              class="text-3xl font-bold text-zinc-900 dark:text-white tracking-tight"
            >
              Shrimp<span class="text-cyan-400">Scan</span>
            </h1>
            <p class="text-zinc-500 text-sm font-mono tracking-wide">
              SHRIMPCHAIN EXPLORER
            </p>
          </div>
        </div>

        <!-- Search Bar -->
        <div class="w-full md:w-auto flex-1 md:max-w-xl md:ml-12 relative">
          <div class="relative group">
            <div
              class="absolute -inset-0.5 bg-gradient-to-r from-cyan-500 to-violet-500 rounded-lg blur opacity-20 group-hover:opacity-40 transition duration-1000 group-hover:duration-200"
            ></div>
            <div
              class="relative flex items-center bg-white dark:bg-zinc-950 rounded-lg border border-zinc-200 dark:border-zinc-800 transition-colors"
            >
              <i data-lucide="search" class="w-5 h-5 ml-3 text-zinc-500"></i>
              <input
                type="text"
                id="search-input"
                placeholder="Search by Block Hash, Tx ID, or Address..."
                class="w-full bg-transparent border-none text-zinc-900 dark:text-white px-4 py-3 focus:outline-none placeholder-zinc-400 dark:placeholder-zinc-600 font-mono text-sm"
                onkeypress="handleKeyPress(event)"
              />
              <button
                onclick="performSearch()"
                class="p-2 mr-1 hover:bg-zinc-800 rounded-md transition-colors text-cyan-500 font-bold text-xs uppercase tracking-wider"
              >
                Search
              </button>
            </div>
          </div>
          <div
            id="search-error"
            class="absolute top-full mt-2 text-xs text-rose-500 hidden"
          ></div>
        </div>

        <div class="flex items-center gap-6 ml-4 hidden md:flex">
          <button
            onclick="toggleTheme()"
            class="p-2 rounded-full hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors text-zinc-500 dark:text-zinc-400"
          >
            <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
            <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
          </button>
          <div class="text-right">
            <div
              class="text-[10px] text-zinc-600 dark:text-zinc-500 uppercase font-bold tracking-widest"
            >
              Node API
            </div>
            <div
              id="api-url-display"
              class="font-mono text-xs text-zinc-500 dark:text-zinc-400"
            >
              Loading...
            </div>
          </div>
        </div>
      </header>

      <!-- Stats Grid: NETWORK -->
      <h3 class="text-xs font-bold text-zinc-500 dark:text-zinc-500 uppercase tracking-widest mb-4">Network Stats</h3>
      <div
        id="stats-network"
        class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8"
      >
        <!-- Height -->
        <div class="bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-900 p-5 rounded-2xl">
           <div class="text-zinc-500 text-xs font-bold uppercase tracking-wider mb-2">Height</div>
           <p id="stat-height" class="text-2xl font-bold text-zinc-900 dark:text-white font-mono">0</p>
        </div>
        <!-- Txs -->
        <div class="bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-900 p-5 rounded-2xl">
           <div class="text-zinc-500 text-xs font-bold uppercase tracking-wider mb-2">Total Txs</div>
           <p id="stat-txs" class="text-2xl font-bold text-zinc-900 dark:text-white font-mono">0</p>
        </div>
        <!-- Difficulty -->
        <div class="bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-900 p-5 rounded-2xl">
           <div class="text-zinc-500 text-xs font-bold uppercase tracking-wider mb-2">Difficulty</div>
           <p id="stat-difficulty" class="text-2xl font-bold text-zinc-900 dark:text-white font-mono">0</p>
        </div>
        <!-- Latest Block -->
        <div class="bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-900 p-5 rounded-2xl">
           <div class="text-zinc-500 text-xs font-bold uppercase tracking-wider mb-2">Latest Block</div>
           <p id="stat-time" class="text-lg font-bold text-zinc-900 dark:text-white font-mono">-</p>
        </div>
      </div>

      <!-- Stats Grid: ECONOMY -->
      <h3 class="text-xs font-bold text-zinc-500 dark:text-zinc-500 uppercase tracking-widest mb-4">Token Economics</h3>
      <div
        id="stats-economy"
        class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-12"
      >
        <!-- MAX SUPPLY -->
        <div class="bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-900 p-6 rounded-2xl relative overflow-hidden group">
           <div class="absolute -right-6 -top-6 w-24 h-24 bg-zinc-500/5 rounded-full blur-2xl group-hover:bg-zinc-500/10 transition-all"></div>
           <div class="relative z-10">
               <div class="text-zinc-400 text-xs font-bold uppercase tracking-wider mb-1">Max Supply</div>
               <p class="text-2xl font-bold text-zinc-900 dark:text-white font-mono">20,000,000</p>
               <p class="text-[10px] text-zinc-500 mt-1">Fixed Cap</p>
           </div>
        </div>

        <!-- TOTAL SUPPLY (MINTED) -->
        <div class="bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-900 p-6 rounded-2xl relative overflow-hidden group">
           <div class="absolute -right-6 -top-6 w-24 h-24 bg-amber-500/5 rounded-full blur-2xl group-hover:bg-amber-500/10 transition-all"></div>
           <div class="relative z-10">
               <div class="text-amber-500/80 text-xs font-bold uppercase tracking-wider mb-1">Total Supply (Minted)</div>
               <p id="stat-supply-total" class="text-2xl font-bold text-amber-600 dark:text-amber-400 font-mono">0</p>
               <p class="text-[10px] text-zinc-500 mt-1">Mined + Genesis</p>
           </div>
        </div>

        <!-- CIRCULATING SUPPLY -->
        <div class="bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-900 p-6 rounded-2xl relative overflow-hidden group ring-1 ring-emerald-500/20">
           <div class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/5 rounded-full blur-2xl group-hover:bg-emerald-500/10 transition-all"></div>
           <div class="relative z-10">
               <div class="text-emerald-600/80 dark:text-emerald-400/80 text-xs font-bold uppercase tracking-wider mb-1">Circulating Supply</div>
               <p id="stat-supply-circulating" class="text-2xl font-bold text-emerald-600 dark:text-emerald-400 font-mono">0</p>
               <p class="text-[10px] text-zinc-500 mt-1">Active Wallet Balances</p>
           </div>
        </div>
      </div>

      <!-- SEARCH RESULTS CONTAINER -->
      <div
        id="search-results-section"
        class="hidden mb-12 animate-in fade-in slide-in-from-bottom-4 duration-500"
      >
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold text-zinc-900 dark:text-white flex items-center gap-2">
            <i data-lucide="search" class="w-6 h-6 text-cyan-400"></i>
            Search Results
          </h2>
          <button
            onclick="resetView()"
            class="px-4 py-2 bg-zinc-100 dark:bg-zinc-900 hover:bg-zinc-200 dark:hover:bg-zinc-800 rounded-lg text-xs font-bold uppercase tracking-wider transition-colors border border-zinc-200 dark:border-zinc-800 text-zinc-600 dark:text-zinc-400"
          >
            Clear Search
          </h2>
        </div>
        <div id="search-results-content"></div>
      </div>

      <!-- DASHBOARD TAB CONTENT -->
      <div id="dashboard-grid" class="flex flex-col gap-8">
        <!-- HOLDER LIST SECTION (Full Width) -->
        <div class="w-full space-y-4">
          <div class="flex items-center justify-between px-2">
            <h2 class="text-xl font-bold text-zinc-900 dark:text-white flex items-center gap-3">
               <i data-lucide="trophy" class="w-6 h-6 text-amber-500"></i>
               Top Holders (Rich List)
            </h2>
          </div>

          <div
            class="bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-900 rounded-xl overflow-hidden"
          >
            <div class="overflow-x-auto">
              <table class="w-full text-left text-sm font-mono">
                <thead class="bg-zinc-100 dark:bg-zinc-900/50 text-zinc-500 uppercase text-xs">
                  <tr>
                    <th class="px-6 py-4 font-bold tracking-wider">Rank</th>
                    <th class="px-6 py-4 font-bold tracking-wider">Address</th>
                    <th class="px-6 py-4 font-bold tracking-wider">Category</th>
                    <th class="px-6 py-4 font-bold tracking-wider text-right">
                      Balance (SHRIMP)
                    </th>
                  </tr>
                </thead>
                <tbody id="holders-table-body" class="divide-y divide-zinc-200 dark:divide-zinc-900">
                  <!-- Data injected here -->
                  <tr>
                    <td colspan="4" class="px-6 py-8 text-center text-zinc-600">
                      Calculating balances...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <!-- Latest Blocks (2/3 width) -->
          <div class="lg:col-span-2 space-y-6">
            <div class="flex items-center justify-between px-2">
              <h2 class="text-xl font-bold text-zinc-900 dark:text-white flex items-center gap-3">
                <i data-lucide="box" class="w-6 h-6 text-cyan-500"></i>
                Latest Blocks
              </h2>
              <span
                id="block-count"
                class="text-xs bg-zinc-100 dark:bg-zinc-900 text-zinc-500 px-3 py-1 rounded-full border border-zinc-200 dark:border-zinc-800 font-mono"
                >0 Blocks</span
              >
            </div>

            <div id="blocks-container" class="space-y-4">
              <!-- Blocks will be inserted here -->
              <div class="p-12 text-center">
                <div
                  class="animate-spin w-8 h-8 border-2 border-cyan-500 border-t-transparent rounded-full mx-auto mb-4"
                ></div>
                <p class="text-zinc-500 font-mono text-sm">
                  Synchronizing with Mainnet...
                </p>
              </div>
            </div>
          </div>

          <!-- Mempool (1/3 width) -->
          <div class="lg:col-span-1 space-y-6">
            <div class="flex items-center justify-between px-2">
              <h2 class="text-xl font-bold text-zinc-900 dark:text-white flex items-center gap-3">
                <i data-lucide="hourglass" class="w-6 h-6 text-amber-500"></i>
                Mempool
              </h2>
              <span
                id="mempool-count"
                class="text-xs bg-zinc-100 dark:bg-zinc-900 text-amber-500 px-3 py-1 rounded-full border border-zinc-200 dark:border-zinc-800 font-mono font-bold"
                >0 Pending</span
              >
            </div>

            <div id="mempool-container" class="space-y-3">
              <!-- Pending Txs will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // CONFIGURATION
      const API_BASE_URL = "https://unveritable-hypsometrical-lochlan.ngrok-free.dev";
      const POLL_INTERVAL = 2000;
      const MINING_REWARD = 1000;
      const HALVING_RATE = 10000;
      const INITIAL_BALANCE = 0;
      const MAX_SUPPLY = MINING_REWARD * HALVING_RATE * 2; // Geometric series sum: 20,000,000

      // Configure Big.js for exact decimal arithmetic
      if (typeof Big !== 'undefined') {
        Big.DP = 8; // 8 decimal places
        Big.RM = Big.roundDown; // Always round down
      }

      // STATE
      let lastBlockHeight = -1;
      let lastMempoolHash = "";
      let fullChain = [];
      let isSearching = false;

      // DOM ELEMENTS
      const blocksContainer = document.getElementById("blocks-container");
      const mempoolContainer = document.getElementById("mempool-container");
      const holdersTableBody = document.getElementById("holders-table-body");
      const apiUrlDisplay = document.getElementById("api-url-display");
      const searchInput = document.getElementById("search-input");
      const dashboardGrid = document.getElementById("dashboard-grid");
      const searchResultsSection = document.getElementById(
        "search-results-section",
      );
      const searchResultsContent = document.getElementById(
        "search-results-content",
      );

      // Stats
      const elHeight = document.getElementById("stat-height");
      const elTxs = document.getElementById("stat-txs");
      const elTime = document.getElementById("stat-time");
      const elDifficulty = document.getElementById("stat-difficulty");
      const elSupplyTotal = document.getElementById("stat-supply-total");
      const elSupplyCirculating = document.getElementById("stat-supply-circulating");

      function toggleTheme() {
        if (document.documentElement.classList.contains("dark")) {
          document.documentElement.classList.remove("dark");
          localStorage.theme = "light";
        } else {
          document.documentElement.classList.add("dark");
          localStorage.theme = "dark";
        }
      }

      apiUrlDisplay.textContent = API_BASE_URL;

      // UTILS
      const formatHash = (hash, len = 8) =>
        hash
          ? `${hash.substring(0, len)}...${hash.substring(hash.length - len)}`
          : "-----";
      const formatTime = (ts) =>
        new Date(ts).toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      const timeAgo = (ts) => {
        const seconds = Math.floor((Date.now() - ts) / 1000);
        if (seconds < 60) return `${seconds}s ago`;
        const minutes = Math.floor(seconds / 60);
        if (minutes < 60) return `${minutes}m ago`;
        return `${Math.floor(minutes / 60)}h ago`;
      };

      // NUMBER FORMATTING - Plain JavaScript number
      const formatNumber = (num) => {
        if (num === null || num === undefined || num === "") return 0;
        const parsed = parseFloat(num);
        if (isNaN(parsed)) return 0;
        return parsed; // Return plain number without formatting
      };

      // COPY TO CLIPBOARD
      function copyToClipboard(text, btnElement) {
        navigator.clipboard.writeText(text);
        const originalIcon = btnElement.innerHTML;
        btnElement.classList.add("copied");
        setTimeout(() => {
          btnElement.classList.remove("copied");
        }, 1500);
      }

      // Helper to render hash with copy button
      function renderHashWithCopy(text, len = 8) {
        if (!text) return "-----";
        return `
            <div class="flex items-center gap-1.5 group/copy">
                <span class="font-mono" title="${text}">${formatHash(text, len)}</span>
                <button onclick="copyToClipboard('${text}', this)" class="text-zinc-600 hover:text-cyan-400 transition-colors p-0.5 rounded copy-btn relative">
                    <i data-lucide="copy" class="w-3 h-3"></i>
                    <span class="copy-tooltip">Copied!</span>
                </button>
            </div>
            `;
      }

      // SEARCH LOGIC
      function handleKeyPress(e) {
        if (e.key === "Enter") performSearch();
      }

      function resetView() {
        isSearching = false;
        searchInput.value = "";
        searchResultsSection.classList.add("hidden");
        dashboardGrid.classList.remove("hidden");
      }

      function performSearch() {
        const query = searchInput.value.trim();
        if (!query) return;

        isSearching = true;
        dashboardGrid.classList.add("hidden");
        searchResultsSection.classList.remove("hidden");

        let resultsHTML = "";
        let found = false;

        // 1. Search Blocks (Hash)
        const block = fullChain.find((b) => b.hash === query);
        if (block) {
          found = true;
          resultsHTML += `<div class="mb-4"><h3 class="text-zinc-500 mb-2">Block Found</h3>${renderBlockCard(block, true)}</div>`;
        }

        // 2. Search Transactions (ID)
        let txFound = null;
        let txBlock = null;
        for (const b of fullChain) {
          if (b.data) {
            const tx = b.data.find((t) => t.id === query);
            if (tx) {
              txFound = tx;
              txBlock = b;
              break;
            }
          }
        }
        if (txFound) {
          found = true;
          resultsHTML += `<div class="mb-4"><h3 class="text-zinc-500 mb-2">Transaction Found (Block ${txBlock.index})</h3>${renderTxCard(txFound)}</div>`;
        }

        // 3. Search Address (Sender or Recipient)
        const addressTxs = [];

        fullChain.forEach((b) => {
          if (b.data) {
            b.data.forEach((tx) => {
              let isRelated = false;
              if (tx.input.address === query) isRelated = true;
              if (tx.outputMap[query] !== undefined) isRelated = true;
              if (isRelated) addressTxs.push({ tx, blockIndex: b.index });
            });
          }
        });

        if (addressTxs.length > 0) {
          found = true;
          resultsHTML += `
                    <div class="mb-6 bg-zinc-900/50 p-6 rounded-xl border border-zinc-800">
                        <h3 class="text-zinc-400 text-sm uppercase tracking-widest mb-1">Address History</h3>
                        <div class="text-xl md:text-2xl font-mono text-white mb-4 break-all flex items-center justify-between">
                            <span>${query}</span>
                            <button onclick="copyToClipboard('${query}', this)" class="bg-zinc-800 hover:bg-zinc-700 p-2 rounded-lg text-zinc-400 copy-btn relative">
                                <i data-lucide="copy" class="w-5 h-5"></i>
                                <span class="copy-tooltip">Copied!</span>
                            </button>
                        </div>
                        <div class="text-zinc-500 text-sm">Found in <b>${addressTxs.length}</b> transactions</div>
                    </div>
                    <div class="space-y-2">
                        ${addressTxs.map((item) => renderTxCard(item.tx, item.blockIndex)).join("")}
                    </div>
                 `;
        }

        if (!found) {
          resultsHTML = `
                    <div class="p-12 text-center text-zinc-500 bg-zinc-900/30 rounded-xl border border-zinc-900 border-dashed">
                        <i data-lucide="search-x" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <p class="text-lg">No results found for</p>
                        <p class="font-mono text-sm mt-2 text-rose-400">${query}</p>
                    </div>
                `;
        }

        searchResultsContent.innerHTML = resultsHTML;
        lucide.createIcons();
      }

      function renderTxCard(tx, blockIndex = null) {
        const isReward = tx.input.address === "*authorized-reward*";
        const outputs = Object.entries(tx.outputMap);

        return `
            <div class="bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-900 rounded-xl mb-4 shadow-sm hover:shadow-md font-mono text-xs md:text-sm hover:border-zinc-300 dark:hover:border-zinc-700 transition-all overflow-hidden scale-100 hover:scale-[1.01]">
                <!-- HEADER -->
                <div class="bg-zinc-50 dark:bg-zinc-900/50 px-6 py-3 border-b border-zinc-200 dark:border-zinc-800 flex justify-between items-center">
                    <div class="flex items-center gap-3">
                         <span class="${isReward ? "bg-emerald-100 text-emerald-700 dark:bg-emerald-500/10 dark:text-emerald-400 border-emerald-200 dark:border-emerald-500/20" : "bg-blue-100 text-blue-700 dark:bg-blue-500/10 dark:text-blue-400 border-blue-200 dark:border-blue-500/20"} px-2 py-0.5 rounded text-[10px] uppercase font-bold border tracking-wider">
                            ${isReward ? 'Reward' : 'Transfer'}
                         </span>
                         <span class="text-zinc-500 dark:text-zinc-400" title="${tx.id}">${formatHash(tx.id, 12)}</span>
                         <button onclick="copyToClipboard('${tx.id}', this)" class="text-zinc-400 hover:text-cyan-500 transition-colors"><i data-lucide="copy" class="w-3 h-3"></i></button>
                    </div>
                    ${blockIndex !== null ? `<span class="bg-zinc-200 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400 px-2 py-0.5 rounded text-[10px]">Block #${blockIndex}</span>` : ""}
                </div>
                
                <div class="p-6 space-y-4">
                    <!-- FROM -->
                     <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                        <div class="w-16 text-zinc-400 dark:text-zinc-500 font-bold uppercase text-[10px] tracking-wider">From</div>
                        <div class="flex items-center gap-2 flex-1">
                            <span class="truncate text-zinc-700 dark:text-zinc-300" title="${tx.input.address}">${formatHash(tx.input.address, 16)}</span>
                            <button onclick="copyToClipboard('${tx.input.address}', this)" class="text-zinc-400 hover:text-cyan-500 transition-colors"><i data-lucide="copy" class="w-3 h-3"></i></button>
                        </div>
                     </div>

                     <!-- TO LIST -->
                     ${outputs.map(([addr, amt]) => {
                        // Skip if address is sender (Change)
                        if (addr === tx.input.address) return '';
                        return `
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4">
                            <div class="w-16 text-zinc-400 dark:text-zinc-500 font-bold uppercase text-[10px] tracking-wider">To</div>
                            <div class="flex items-center gap-2 flex-1">
                                <span class="truncate text-zinc-700 dark:text-zinc-300" title="${addr}">${formatHash(addr, 16)}</span>
                                <button onclick="copyToClipboard('${addr}', this)" class="text-zinc-400 hover:text-cyan-500 transition-colors"><i data-lucide="copy" class="w-3 h-3"></i></button>
                            </div>
                            <div class="font-bold text-zinc-900 dark:text-white">
                                ${formatNumber(amt)} <span class="text-zinc-500 text-xs font-normal">SHRIMP</span>
                            </div>
                        </div>
                        `;
                     }).join('')}

                     <!-- FEE / REWARD BREAKDOWN -->
                     ${!isReward ? (() => {
                        // Use Big.js for exact fee calculation
                        let fee = 0;
                        if (typeof Big !== 'undefined') {
                          try {
                            let outputTotal = new Big(0);
                            outputs.forEach(([_, amt]) => {
                              outputTotal = outputTotal.plus(new Big(amt));
                            });
                            const inputAmount = new Big(tx.input.amount);
                            fee = parseFloat(inputAmount.minus(outputTotal).toString());
                          } catch (e) {
                            const outputTotal = outputs.reduce((sum, [_, amt]) => sum + parseFloat(amt), 0);
                            fee = parseFloat(tx.input.amount) - outputTotal;
                          }
                        } else {
                          const outputTotal = outputs.reduce((sum, [_, amt]) => sum + parseFloat(amt), 0);
                          fee = parseFloat(tx.input.amount) - outputTotal;
                        }
                        
                        return `
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 pt-4 mt-2 border-t border-zinc-100 dark:border-zinc-800/50">
                            <div class="w-16 text-zinc-400 dark:text-zinc-500 font-bold uppercase text-[10px] tracking-wider">Fee</div>
                            <div class="text-zinc-500 dark:text-zinc-400 text-xs">
                                ${formatNumber(fee > 0 ? fee : 0)} SHRIMP
                            </div>
                        </div>
                        `;
                     })() : (() => {
                        const totalReward = outputs.reduce((sum, [_, amt]) => sum + parseFloat(amt), 0);
                        const fees = totalReward - MINING_REWARD;
                        if (fees <= 0) return '';
                        return `
                        <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 pt-4 mt-2 border-t border-zinc-100 dark:border-zinc-800/50">
                            <div class="w-16 text-zinc-400 dark:text-zinc-500 font-bold uppercase text-[10px] tracking-wider">Breakdown</div>
                            <div class="text-zinc-500 dark:text-zinc-400 text-xs flex items-center gap-2">
                                <span>${formatNumber(MINING_REWARD)} (Block Reward)</span>
                                <span class="text-zinc-300">+</span>
                                <span class="text-emerald-500 font-bold">${formatNumber(fees)} (Fees)</span>
                            </div>
                        </div>
                        `;
                     })()}
                </div>
            </div>
            `;
      }

      function getMiner(block) {
        if (!block.data) return "Unknown";
        const rewardTx = block.data.find(
          (tx) => tx.input.address === "*authorized-reward*",
        );
        if (rewardTx) return Object.keys(rewardTx.outputMap)[0];
        return "System";
      }

      function renderBlockCard(block, expanded = false) {
        const txCount = block.data ? block.data.length : 0;
        const isGenesis = block.lastHash === "-----";
        const miner = getMiner(block);

        const txListHTML = block.data
          .map((tx) => renderTxCard(tx))
          .join("");

        return `
             <div data-hash="${block.hash}" class="block-card bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-900 rounded-xl overflow-hidden hover:border-zinc-300 dark:hover:border-zinc-800 transition-all duration-500 animate-in slide-in-from-top-4 fade-in">
                <div class="p-5 flex items-start justify-between">
                    <div class="flex items-start gap-4">
                        <div>
                            <div class="bg-zinc-100 dark:bg-zinc-900 w-14 h-14 rounded-lg flex flex-col items-center justify-center border border-zinc-200 dark:border-zinc-800">
                                <span class="text-[10px] text-zinc-500 font-bold uppercase">Block</span>
                                <span class="text-xl font-bold text-zinc-900 dark:text-white font-mono">${block.index !== undefined ? block.index : "?"}</span>
                            </div>
                        </div>
                        <div class="space-y-1">
                            <div class="flex items-center gap-3">
                                ${renderHashWithCopy(block.hash, 10)}
                                ${isGenesis ? '<span class="px-2 py-0.5 bg-violet-500/10 border border-violet-500/20 text-violet-600 dark:text-violet-400 text-[10px] rounded uppercase font-bold tracking-wider">Genesis</span>' : ""}
                            </div>
                            <div class="flex items-center gap-4 text-xs text-zinc-500">
                                <div class="flex items-center gap-1.5"><i data-lucide="pickaxe" class="w-3 h-3"></i>${renderHashWithCopy(miner, 6)}</div>
                                <div class="flex items-center gap-1.5"><i data-lucide="clock" class="w-3 h-3"></i><span class="time-ago" data-ts="${block.timestamp}">${formatTime(block.timestamp)}</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right space-y-2">
                         <div class="flex items-center justify-end gap-2">
                            <span class="px-2 py-1 bg-zinc-100 dark:bg-zinc-900 rounded border border-zinc-200 dark:border-zinc-800 text-xs font-mono text-zinc-500 dark:text-zinc-400">Nonce: <span class="text-zinc-900 dark:text-white">${block.nonce}</span></span>
                            <span class="px-2 py-1 bg-zinc-100 dark:bg-zinc-900 rounded border border-zinc-200 dark:border-zinc-800 text-xs font-mono text-zinc-500 dark:text-zinc-400">Diff: <span class="text-rose-500 dark:text-rose-400">${block.difficulty}</span></span>
                         </div>
                         <button onclick="toggleDetails('${block.hash}')" class="text-xs text-zinc-500 hover:text-zinc-900 dark:hover:text-white flex items-center justify-end gap-1 ml-auto transition-colors">
                            ${txCount} Transactions <i data-lucide="chevron-down" class="w-3 h-3"></i>
                         </button>
                    </div>
                </div>
                <div class="bg-zinc-50 dark:bg-zinc-900/50 border-t border-zinc-200 dark:border-zinc-900 p-4 text-xs font-mono ${expanded ? "" : "hidden"}" id="details-${block.hash}">
                     <div class="space-y-2">${txListHTML}</div>
                </div>
            </div>
            `;
      }

      // --- NEW: CALCULATE BALANCES & RENDER HOLDERS ---
      function calculateAndRenderHolders(chain) {
        const balances = {};

        // Chronological playback for O(N) calculation
        chain.forEach((block) => {
          if (!block.data) return;
          block.data.forEach((tx) => {
            const sender = tx.input.address;

            // Handle Sender: Subtract input and add back change (outputMap[sender])
            // In account-based with change, input amount is the PREVIOUS balance.
            // So balance = outputMap[sender] is the simplest for the sender.
            if (sender !== "*authorized-reward*") {
              balances[sender] = tx.outputMap[sender] || 0;
            }

            // Handle Recipients: Add outputs to their current balance
            Object.entries(tx.outputMap).forEach(([addr, amt]) => {
              if (addr !== sender) {
                balances[addr] = (balances[addr] || 0) + parseFloat(amt);
              }
            });
          });
        });

        const holderList = Object.entries(balances)
          .filter(([_, balance]) => balance > 0)
          .map(([address, balance]) => ({ address, balance }));

        // Sort by balance DESC
        holderList.sort((a, b) => b.balance - a.balance);

        const totalCirculating = holderList.reduce((sum, h) => sum + h.balance, 0);
        
        if(elSupplyCirculating) elSupplyCirculating.textContent = formatNumber(totalCirculating);
        
        renderHoldersTable(holderList);
      }

      function getCategory(balance) {
        if (balance > 1000000)
          return {
            name: "WHALE",
            color: "text-rose-500 bg-rose-500/10 border-rose-500/20",
          };
        if (balance > 1000)
          return {
            name: "MINER",
            color: "text-amber-500 bg-amber-500/10 border-amber-500/20",
          };
        if (balance > 100)
          return {
            name: "SHARK",
            color: "text-cyan-500 bg-cyan-500/10 border-cyan-500/20",
          };
        return {
          name: "MINI FISH",
          color: "text-emerald-500 bg-emerald-500/10 border-emerald-500/20",
        };
      }

      function renderHoldersTable(holders) {
        const topHolders = holders.slice(0, 10);
        
        // Optimization: Don't re-render if data hasn't changed
        const currentDataJson = JSON.stringify(topHolders);
        if (holdersTableBody.dataset.lastJson === currentDataJson) return;
        holdersTableBody.dataset.lastJson = currentDataJson;

        if (topHolders.length === 0) {
          holdersTableBody.innerHTML = `<tr><td colspan="4" class="px-6 py-8 text-center text-zinc-600">No holders found yet.</td></tr>`;
          return;
        }

        holdersTableBody.innerHTML = topHolders
          .map((h, i) => {
            return `
                <tr class="hover:bg-zinc-100 dark:hover:bg-zinc-900/50 transition-colors group">
                    <td class="px-6 py-4 whitespace-nowrap text-zinc-500 dark:text-zinc-400 font-mono text-xs">#${i + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center gap-2">
                             <div class="font-mono text-zinc-700 dark:text-zinc-300 truncate w-32 md:w-auto" title="${h.address}">${formatHash(h.address, 12)}</div>
                             <button onclick="copyToClipboard('${h.address}', this)" class="text-zinc-500 dark:text-zinc-600 hover:text-zinc-900 dark:hover:text-white copy-btn relative p-1"><i data-lucide="copy" class="w-3 h-3"></i><span class="copy-tooltip">Copied!</span></button>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 rounded text-[10px] font-bold tracking-wider border ${getCategory(h.balance).color}">${getCategory(h.balance).name}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right font-mono text-zinc-900 dark:text-white font-bold">
                        ${formatNumber(h.balance)} <span class="text-zinc-500 dark:text-zinc-600 text-xs font-normal">SHRIMP</span>
                    </td>
                </tr>
                `;
          })
          .join("");
        lucide.createIcons();
      }

      // FETCH BLOCKS
      async function fetchBlocks() {
        try {
          const res = await fetch(`${API_BASE_URL}/blocks`, {
            headers: { 'ngrok-skip-browser-warning': 'true' }
          });
          const chain = await res.json();
          fullChain = chain;

          if (!isSearching) {
            const viewChain = [...chain].reverse();

            if (chain.length !== lastBlockHeight) {
              lastBlockHeight = chain.length;
              renderBlocks(viewChain);
              elHeight.textContent = chain.length;
              const totalTxs = chain.reduce(
                (acc, block) => acc + (block.data ? block.data.length : 0),
                0,
              );
              elTxs.textContent = totalTxs;
              elTime.textContent = timeAgo(viewChain[0].timestamp);
              elDifficulty.textContent = viewChain[0].difficulty;
              document.getElementById("block-count").textContent =
                `${chain.length} Blocks`;



              // Supply (Dynamic Calculation) - TOTAL MINTED
              const totalMinted = chain.reduce((total, block) => {
                if (!block.data) return total;
                const rewardTx = block.data.find(
                  (tx) => tx.input.address === "*authorized-reward*",
                );
                if (rewardTx) {
                  return (
                    total +
                    Object.values(rewardTx.outputMap).reduce(
                      (sum, val) => sum + val,
                      0,
                    )
                  );
                }
                return total;
              }, INITIAL_BALANCE);
              
              if(elSupplyTotal) elSupplyTotal.textContent = formatNumber(totalMinted);

              // Calculate Holders & Circulating
              calculateAndRenderHolders(chain);
            }
          }
        } catch (error) {
          console.error("Failed to fetch blocks:", error);
          document.getElementById("api-url-display").innerHTML =
            `<span class="text-rose-500 font-bold">OFFLINE</span>`;
        }
      }

      function renderBlocks(chain) {
        // SMOOTH UPDATE STRATEGY
        // chain is already reversed (newest first)
        
        const firstBlock = document.querySelector(".block-card");
        let lastRenderedHash = firstBlock ? firstBlock.getAttribute("data-hash") : null;

        if (!lastRenderedHash || chain.length === 0) {
           // Initial render or Reset
           blocksContainer.innerHTML = chain
             .map((block, index) => renderBlockCard(block, false))
             .join("");
        } else {
            // Find where the last rendered block is in the new chain
            const matchIndex = chain.findIndex(b => b.hash === lastRenderedHash);
            
            if (matchIndex === -1) {
                // Formatting/Reorg detected - Full Re-render
                blocksContainer.innerHTML = chain
                 .map((block, index) => renderBlockCard(block, false))
                 .join("");
            } else if (matchIndex > 0) {
                // Found new blocks!
                const newBlocks = chain.slice(0, matchIndex);
                // Reverse needed? No, logic: 
                // chain: [New3, New2, New1, OldTop, ...]
                // DOM:   [OldTop, ...]
                // We want to prepend New1, then New2, then New3? 
                // No, we want [New3, New2, New1] prepended.
                // insertAdjacentHTML('afterbegin') injects right at the top.
                // If we inject "A B C", it appears as A B C at top.
                // So maintaining order is correct.
                
                
                const newHtml = newBlocks.map(b => renderBlockCard(b, false)).join("");
                blocksContainer.insertAdjacentHTML("afterbegin", newHtml);
                
                // Limit rendered blocks to prevent DOM bloat (maintain 50 max)
                while (blocksContainer.children.length > 50) {
                    blocksContainer.removeChild(blocksContainer.lastElementChild);
                }
            }
            // If matchIndex === 0, nothing new.
        }
        lucide.createIcons();
      }

      function toggleDetails(hash) {
        const el = document.getElementById(`details-${hash}`);
        el.classList.toggle("hidden");
      }

      async function fetchMempool() {
        try {
          const res = await fetch(`${API_BASE_URL}/transactions`, {
            headers: { 'ngrok-skip-browser-warning': 'true' }
          });
          const mempoolMap = await res.json();
          const txs = Object.values(mempoolMap);

          const currentHash = JSON.stringify(txs.map((t) => t.id));
          if (currentHash !== lastMempoolHash) {
            lastMempoolHash = currentHash;
            renderMempool(txs);
          }
        } catch (error) {
          console.error("Failed to fetch mempool:", error);
        }
      }

      let lastMempoolJson = "";
      function renderMempool(txs) {
        const currentJson = JSON.stringify(txs);
        if (currentJson === lastMempoolJson) return; // No change
        lastMempoolJson = currentJson;

        document.getElementById("mempool-count").textContent =
          `${txs.length} Pending`;

        if (txs.length === 0) {
          mempoolContainer.innerHTML = `
                    <div class="bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-900 border-dashed rounded-xl p-8 flex flex-col items-center justify-center text-zinc-400 dark:text-zinc-600">
                        <i data-lucide="inbox" class="w-8 h-8 mb-2 opacity-50"></i>
                        <p class="text-sm font-mono">Mempool Empty</p>
                    </div>
                `;
        } else {
          mempoolContainer.innerHTML = txs
            .map((tx) => renderTxCard(tx))
            .join("");
        }
        lucide.createIcons();
      }

      // Placeholder for updateStats, as it's called in the new WS logic but not defined in the original
      function updateStats(chain) {
        // Implement logic to update stats based on the chain, similar to what was in fetchChain
        const viewChain = [...chain].reverse();
        elHeight.textContent = chain.length;
        const totalTxs = chain.reduce(
          (acc, block) => acc + (block.data ? block.data.length : 0),
          0,
        );
        elTxs.textContent = totalTxs;
        if (viewChain.length > 0) {
          elTime.textContent = timeAgo(viewChain[0].timestamp);
          elDifficulty.textContent = viewChain[0].difficulty;
        }
        document.getElementById("block-count").textContent =
          `${chain.length} Blocks`;


      }

      // WEBSOCKET (REALTIME UPDATES)
      let ws;
      function connectWebSocket() {
        try {
          // Infer P2P URL
          const url = new URL(API_BASE_URL);
          const p2pPort = 5001; // Default
          const wsUrl = `ws://${url.hostname}:${p2pPort}`;
          console.log(`Connecting to P2P Node at ${wsUrl}...`);

          ws = new WebSocket(wsUrl);

          ws.onopen = () => {
            console.log("‚úÖ Connected to P2P Network!");
            apiUrlDisplay.textContent = `${API_BASE_URL} (REALTIME)`;
            apiUrlDisplay.classList.add("text-emerald-500");
            apiUrlDisplay.classList.remove("text-zinc-400", "text-rose-500");
          };

          ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);

              // 1. Handle New Chain (Blocks)
              if (data.type === "CHAIN") {
                // Only update if chain length changed or hash changed (new block)
                const newChain = data.chain;
                if (
                  newChain.length > fullChain.length ||
                  (newChain.length > 0 &&
                    fullChain.length > 0 &&
                    newChain[newChain.length - 1].hash !==
                      fullChain[fullChain.length - 1].hash)
                ) {
                  fullChain = newChain;
                  renderBlocks([...fullChain].reverse()); // Render in reverse for display
                  updateStats(fullChain);
                  calculateAndRenderHolders(fullChain);

                  if (isSearching) performSearch(); // Refresh search if active
                }
              }

              // 2. Handle Mempool Updates
              if (data.type === "MEMPOOL") {
                renderMempool(Object.values(data.transactionMap)); // Convert map to array for renderMempool
              }
              if (data.type === "TRANSACTION") {
                // Add single tx to mempool view individually for smoother UX?
                // Or just wait for full mempool sync. P2P sends transactionMap on connect, and broadcasts individual txs.
                // But our P2P Server 'broadcastTransaction' sends the TX object.
                // We need to maintain a local mempool state or request it?
                // P2P Server sends 'MEMPOOL' (map) on connect.
                // P2P Server sends 'TRANSACTION' (single) on new tx.
                // P2P Server sends 'CLEAR_TRANSACTIONS' on block mine.

                // We should maintain a local mempool object to render it.
                // Let's assume we fetch full mempool initially (via HTTP or WS 'MEMPOOL' msg)
                // For now, let's just re-fetch mempool from API to be safe/simple, OR implement full mempool state sync.
                // Simpler: Just fetch mempool from API on 'TRANSACTION' event.
                fetchMempool();
              }
              if (data.type === "CLEAR_TRANSACTIONS") {
                fetchMempool();
              }
            } catch (e) {
              console.error("WS Parse Error", e);
            }
          };

          ws.onclose = () => {
            console.log("‚ùå P2P Connection Lost. Retrying...");
            apiUrlDisplay.textContent = `${API_BASE_URL} (DISCONNECTED)`;
            apiUrlDisplay.classList.add("text-rose-500");
            apiUrlDisplay.classList.remove("text-emerald-500");
            setTimeout(connectWebSocket, 5000);
          };

          ws.onerror = (err) => console.error("WS Error", err);
        } catch (e) {
          console.error("Failed to setup WebSocket", e);
        }
      }

      // INIT
      fetchBlocks();
      fetchMempool();
      connectWebSocket(); // Start WS instead of polling

      // Fallback: Still fetch frequently if WS is not open
      setInterval(() => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          fetchBlocks();
          fetchMempool();
        }
      }, POLL_INTERVAL);

      // Automatic Time-Ago Updater
      setInterval(() => {
         // This runs every minute to update relative times if we used them, 
         // but currently we display fixed times. 
         // If we switch to relative times (e.g. "5 mins ago"), this is where we'd update them.
         // For now, it's a placeholder or can be removed if not used. 
         // Actually, let's leave it empty to avoid unnecessary CPU usage since we use formatTime (HH:MM:SS).
      }, 60000);
    </script>
  </body>
</html>
