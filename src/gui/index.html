<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ü¶ê ShrimpChain GUI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      body {
        font-family: "Space Grotesk", sans-serif;
      }
      .glass {
        background: rgba(24, 24, 27, 0.6);
        backdrop-filter: blur(12px);
      }
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: #09090b;
      }
      ::-webkit-scrollbar-thumb {
        background: #27272a;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #3f3f46;
      }
    </style>
  </head>
  <body class="bg-black text-zinc-300 min-h-screen flex overflow-hidden">
    <!-- Mobile Menu Toggle -->
    <button
      id="mobile-menu-btn"
      class="fixed top-4 left-4 z-50 lg:hidden bg-zinc-900 p-3 rounded-xl border border-zinc-800 shadow-lg"
      onclick="toggleMobileMenu()"
    >
      <i data-lucide="menu" class="w-5 h-5 text-white"></i>
    </button>

    <!-- SIDEBAR -->
    <aside
      id="sidebar"
      class="fixed lg:relative w-64 lg:w-20 lg:lg:w-64 h-full border-r border-zinc-900 flex flex-col justify-between bg-zinc-950 z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300"
    >
      <div>
        <div class="p-6 flex items-center gap-3">
          <div
            class="w-10 h-10 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-cyan-500/20"
          >
            <span class="text-2xl">ü¶ê</span>
          </div>
          <span
            class="font-bold text-xl text-white hidden lg:block tracking-tight"
            >Shrimp<span class="text-cyan-400">GUI</span></span
          >
        </div>

        <nav class="mt-8 px-4 space-y-2">
          <button
            onclick="switchTab('dashboard')"
            id="nav-dashboard"
            class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-zinc-400 hover:text-white hover:bg-zinc-900 transition-all group active"
          >
            <i
              data-lucide="layout-dashboard"
              class="w-5 h-5 group-hover:text-cyan-400 transition-colors"
            ></i>
            <span class="hidden lg:block font-medium">Dashboard</span>
          </button>
          <button
            onclick="switchTab('wallets')"
            id="nav-wallets"
            class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-zinc-400 hover:text-white hover:bg-zinc-900 transition-all group"
          >
            <i
              data-lucide="wallet"
              class="w-5 h-5 group-hover:text-emerald-400 transition-colors"
            ></i>
            <span class="hidden lg:block font-medium">Wallets</span>
          </button>
          <button
            onclick="switchTab('send')"
            id="nav-send"
            class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-zinc-400 hover:text-white hover:bg-zinc-900 transition-all group"
          >
            <i
              data-lucide="send"
              class="w-5 h-5 group-hover:text-blue-400 transition-colors"
            ></i>
            <span class="hidden lg:block font-medium">Send</span>
          </button>
          <button
            onclick="switchTab('miner')"
            id="nav-miner"
            class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-zinc-400 hover:text-white hover:bg-zinc-900 transition-all group"
          >
            <i
              data-lucide="pickaxe"
              class="w-5 h-5 group-hover:text-amber-400 transition-colors"
            ></i>
            <span class="hidden lg:block font-medium">Miner</span>
          </button>
          <button
            onclick="switchTab('settings')"
            id="nav-settings"
            class="nav-item w-full flex items-center gap-4 px-4 py-3 rounded-xl text-zinc-400 hover:text-white hover:bg-zinc-900 transition-all group"
          >
            <i
              data-lucide="settings"
              class="w-5 h-5 group-hover:text-rose-400 transition-colors"
            ></i>
            <span class="hidden lg:block font-medium">Settings</span>
          </button>
        </nav>
      </div>

      <div class="p-4 border-t border-zinc-900">
        <div class="flex items-center gap-3 px-2 py-2">
          <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
          <span
            class="text-xs text-zinc-500 hidden lg:block font-mono"
            id="node-status"
            >Connected</span
          >
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative">
      <!-- HEADER -->
      <header
        class="h-16 border-b border-zinc-900 flex items-center justify-between px-8 bg-zinc-950/30 backdrop-blur-sm z-10"
      >
        <h2 id="page-title" class="text-lg font-bold text-white">Dashboard</h2>

        <div class="flex items-center gap-4">
          <!-- Wallet Selector -->
          <div class="relative group">
            <button
              id="wallet-select-btn"
              class="flex items-center gap-2 bg-zinc-900 hover:bg-zinc-800 px-3 py-1.5 rounded-lg border border-zinc-800 transition-colors text-sm"
            >
              <span id="current-wallet-name" class="text-zinc-300"
                >Loading...</span
              >
              <i data-lucide="chevron-down" class="w-4 h-4 text-zinc-500"></i>
            </button>
            <div
              id="wallet-dropdown"
              class="absolute right-0 top-full mt-2 w-48 bg-zinc-900 border border-zinc-800 rounded-xl shadow-xl hidden overflow-hidden z-50"
            >
              <!-- Wallet items injected here -->
            </div>
          </div>
        </div>
      </header>

      <!-- SCROLLABLE CONTENT -->
      <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 relative">
        <!-- DASHBOARD TAB -->
        <div
          id="tab-dashboard"
          class="tab-content space-y-8 animate-in fade-in zoom-in-95 duration-300"
        >
          <!-- Balance Card -->
          <div
            class="bg-gradient-to-br from-zinc-900 to-black p-6 md:p-8 rounded-2xl md:rounded-3xl border border-zinc-800 relative overflow-hidden"
          >
            <div
              class="absolute top-0 right-0 w-64 h-64 bg-cyan-500/10 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"
            ></div>

            <div class="relative z-10">
              <p
                class="text-zinc-500 uppercase tracking-widest text-xs font-bold mb-2"
              >
                Total Balance
              </p>
              <h1
                class="text-4xl md:text-5xl lg:text-7xl font-bold text-white mb-2 font-mono tracking-tighter"
              >
                <span id="balance-display">0</span>
                <span class="text-xl md:text-2xl lg:text-4xl text-cyan-500/50"
                  >SHRIMP</span
                >
              </h1>

              <div class="flex items-center gap-4 mt-6">
                <div
                  class="bg-zinc-950/50 px-4 py-2 rounded-lg border border-zinc-800 flex items-center gap-3"
                >
                  <span class="text-zinc-500 text-xs uppercase">Address</span>
                  <span
                    id="address-display"
                    class="font-mono text-zinc-300 text-sm"
                    >...</span
                  ><button
                    onclick="copyAddress()"
                    class="hover:text-cyan-400 transition-colors"
                  >
                    <i data-lucide="copy" class="w-4 h-4"></i>
                  </button>
                </div>
                <button
                  onclick="startAutoMining()"
                  id="btn-start-mining"
                  class="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl transition-all active:scale-95 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  <i data-lucide="pickaxe" class="w-5 h-5"></i>
                  Start Mining
                </button>
              </div>
            </div>
          </div>

          <!-- Recent Activity (Logs) -->
          <div
            class="bg-zinc-950 border border-zinc-900 rounded-2xl p-6 h-96 flex flex-col"
          >
            <h3
              class="text-lg font-bold text-white mb-4 flex items-center gap-2"
            >
              <i data-lucide="activity" class="w-5 h-5 text-violet-500"></i>
              Node Activity Log
            </h3>
            <div
              id="logs-container"
              class="flex-1 overflow-y-auto font-mono text-xs space-y-2 pr-2 text-zinc-400"
            >
              <!-- Logs injected here -->
              <div class="text-zinc-600 italic">Waiting for connection...</div>
            </div>
          </div>
        </div>

        <!-- WALLETS TAB -->
        <div id="tab-wallets" class="tab-content hidden space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Create Wallet -->
            <div
              class="bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800 hover:border-emerald-500/50 transition-all cursor-pointer group"
              onclick="showModal('create-wallet-modal')"
            >
              <div
                class="w-12 h-12 bg-emerald-500/10 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform"
              >
                <i data-lucide="plus" class="w-6 h-6 text-emerald-500"></i>
              </div>
              <h3 class="text-xl font-bold text-white mb-1">
                Create New Wallet
              </h3>
              <p class="text-zinc-500 text-sm">
                Generate a new key pair and mnemonic phrase.
              </p>
            </div>

            <!-- Import Wallet -->
            <div
              class="bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800 hover:border-blue-500/50 transition-all cursor-pointer group"
              onclick="showModal('import-wallet-modal')"
            >
              <div
                class="w-12 h-12 bg-blue-500/10 rounded-full flex items-center justify-center mb-4 group-hover:scale-110 transition-transform"
              >
                <i data-lucide="download" class="w-6 h-6 text-blue-500"></i>
              </div>
              <h3 class="text-xl font-bold text-white mb-1">Import Wallet</h3>
              <p class="text-zinc-500 text-sm">
                Restore an existing wallet using mnemonic.
              </p>
            </div>
          </div>

          <div class="mt-8">
            <h3
              class="text-zinc-500 text-sm font-bold uppercase tracking-wider mb-4"
            >
              Your Wallets
            </h3>
            <div id="wallet-list-container" class="space-y-3">
              <!-- Injected items -->
            </div>
          </div>
        </div>

        <!-- SEND TAB -->
        <div id="tab-send" class="tab-content hidden max-w-2xl mx-auto pt-12">
          <div
            class="bg-zinc-900/50 border border-zinc-800 p-8 rounded-3xl relative overflow-hidden"
          >
            <div
              class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-cyan-500"
            ></div>
            <h2 class="text-2xl font-bold text-white mb-8">Send SHRIMP</h2>

            <div class="space-y-6">
              <div>
                <label
                  class="block text-xs uppercase font-bold text-zinc-500 mb-2"
                  >Recipient Address</label
                >
                <input
                  id="send-recipient"
                  type="text"
                  placeholder="Paste wallet address here..."
                  class="w-full bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-cyan-500 transition-colors font-mono text-sm"
                />
              </div>

              <div>
                <label
                  class="block text-xs uppercase font-bold text-zinc-500 mb-2"
                  >Amount</label
                >
                <div class="relative">
                  <input
                    id="send-amount"
                    type="number"
                    placeholder="0.00"
                    class="w-full bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-cyan-500 transition-colors font-mono text-lg font-bold"
                  />
                  <div
                    class="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500 text-sm font-bold"
                  >
                    SHRIMP
                  </div>
                </div>
                <div class="text-right mt-2 text-xs text-zinc-500">
                  Available:
                  <span
                    id="send-max-balance"
                    class="text-white cursor-pointer hover:underline"
                    >0</span
                  >
                </div>
              </div>

              <div>
                <label
                  class="block text-xs uppercase font-bold text-zinc-500 mb-2"
                  >Fee (Optional)</label
                >
                <div class="relative">
                  <input
                    id="send-fee"
                    type="number"
                    placeholder="1.00"
                    value="1"
                    min="1"
                    class="w-full bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-amber-500 transition-colors font-mono text-lg font-bold"
                  />
                  <div
                    class="absolute right-4 top-1/2 -translate-y-1/2 text-zinc-500 text-sm font-bold"
                  >
                    SHRIMP
                  </div>
                </div>
                <div class="text-right mt-2 text-xs text-zinc-500">
                  Min Fee: 1 SHRIMP (Impacts Priority)
                </div>
              </div>

              <button
                onclick="sendTransaction()"
                class="w-full bg-white text-black font-bold py-4 rounded-xl hover:bg-cyan-400 transition-colors mt-4 flex justify-center items-center gap-2"
              >
                <span id="send-btn-text">Confirm Transaction</span>
                <div
                  id="send-spinner"
                  class="hidden w-5 h-5 border-2 border-black border-t-transparent rounded-full animate-spin"
                ></div>
              </button>

              <div
                id="send-status"
                class="hidden p-4 rounded-xl text-center text-sm font-bold"
              ></div>
            </div>
          </div>
        </div>

        <!-- MINER TAB -->
        <div id="tab-miner" class="tab-content hidden pt-8">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Status Card -->
            <div
              class="bg-zinc-900/50 border border-zinc-800 p-8 rounded-3xl flex flex-col items-center justify-center text-center"
            >
              <div
                id="miner-icon-bg"
                class="w-24 h-24 bg-zinc-800 rounded-full flex items-center justify-center mb-6 transition-colors duration-500"
              >
                <i
                  id="miner-icon"
                  data-lucide="pickaxe"
                  class="w-10 h-10 text-zinc-500 transition-colors duration-500"
                ></i>
              </div>
              <h2 class="text-2xl font-bold text-white mb-2">Miner Status</h2>
              <div id="miner-status-text" class="text-zinc-500 mb-8 font-mono">
                IDLE
              </div>

              <button
                onclick="toggleAutoMining()"
                id="miner-toggle-btn"
                class="px-8 py-3 rounded-xl bg-zinc-800 text-white font-bold hover:bg-zinc-700 transition-all border border-zinc-700 w-full max-w-xs"
              >
                Start Auto-Mining
              </button>

              <div class="mt-8 pt-8 border-t border-zinc-800 w-full">
                <button
                  onclick="mineBlockOnce()"
                  class="text-sm text-zinc-500 hover:text-white underline"
                >
                  Mine Single Block (Manual)
                </button>
              </div>
            </div>

            <!-- Info -->
            <div class="space-y-6">
              <div class="bg-zinc-950 border border-zinc-900 p-6 rounded-2xl">
                <h3 class="text-zinc-500 text-xs font-bold uppercase mb-4">
                  Mining Info
                </h3>
                <div class="space-y-4">
                  <div class="flex justify-between">
                    <span class="text-zinc-400">Reward Address</span>
                    <span
                      id="miner-address"
                      class="font-mono text-xs text-white truncate w-32"
                      >...</span
                    >
                  </div>
                  <div class="flex justify-between">
                    <span class="text-zinc-400">Difficulty</span>
                    <span
                      class="font-mono text-white text-xs font-bold text-rose-500"
                      >DYNAMIC</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- NETWORK TAB -->
        <div id="tab-network" class="tab-content hidden space-y-6">
          <header class="flex justify-between items-center mb-8">
            <div>
              <h2 class="text-2xl font-bold text-white mb-1">Network</h2>
              <p class="text-zinc-400 text-sm">Manage P2P connections</p>
            </div>
            <div class="flex items-center gap-2">
              <span
                class="w-3 h-3 rounded-full bg-rose-500 animate-pulse"
                id="network-status-dot"
              ></span>
              <span
                class="text-sm font-mono text-zinc-400"
                id="network-status-text"
                >Disconnected</span
              >
            </div>
          </header>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Connect Peer -->
            <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6">
              <h3
                class="text-lg font-bold text-white mb-4 flex items-center gap-2"
              >
                <i data-lucide="plug" class="w-5 h-5 text-cyan-500"></i>
                Connect to Peer
              </h3>
              <div class="space-y-4">
                <div>
                  <label
                    class="block text-xs font-bold text-zinc-500 uppercase mb-1"
                    >Peer URL</label
                  >
                  <input
                    type="text"
                    id="peer-url-input"
                    placeholder="ws://localhost:5001"
                    class="w-full bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-cyan-500 transition-colors"
                    value="ws://localhost:5001"
                  />
                </div>
                <button
                  onclick="connectToPeer()"
                  class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-xl transition-all active:scale-95"
                >
                  Connect
                </button>
              </div>
            </div>

            <!-- Active Peers -->
            <div class="bg-zinc-900 border border-zinc-800 rounded-2xl p-6">
              <h3
                class="text-lg font-bold text-white mb-4 flex items-center gap-2"
              >
                <i data-lucide="users" class="w-5 h-5 text-emerald-500"></i>
                Connected Peers
              </h3>
              <div id="peers-list" class="space-y-2">
                <div class="text-zinc-500 text-center py-8 italic">
                  No peers connected
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SETTINGS TAB -->
        <div
          id="tab-settings"
          class="tab-content hidden max-w-4xl mx-auto pt-4 md:pt-12"
        >
          <div class="space-y-6">
            <!-- API Settings -->
            <div class="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-4 md:p-6">
              <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="settings" class="w-5 h-5 text-cyan-500"></i>
                API Settings
              </h3>
              <div class="space-y-4">
                <div>
                  <label class="block text-xs uppercase font-bold text-zinc-500 mb-2">Node API URL</label>
                  <input
                    id="node-url-input"
                    type="text"
                    class="w-full bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white font-mono text-sm focus:outline-none focus:border-cyan-500 transition-colors"
                  />
                </div>
                <div>
                  <label class="block text-xs uppercase font-bold text-zinc-500 mb-2">GUI API URL (Local)</label>
                  <input
                    id="gui-url-input"
                    type="text"
                    value="http://localhost:3002"
                    disabled
                    class="w-full bg-zinc-900 border border-zinc-800 rounded-xl px-4 py-3 text-zinc-500 font-mono text-sm cursor-not-allowed"
                  />
                </div>
                <button
                  onclick="saveSettings()"
                  class="w-full bg-white text-black font-bold py-3 rounded-xl hover:bg-cyan-400 transition-colors"
                >
                  Save Settings
                </button>
              </div>
            </div>

            <!-- Connected Nodes -->
            <div class="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-4 md:p-6">
              <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="network" class="w-5 h-5 text-emerald-500"></i>
                Connected Nodes
                <span id="connected-count" class="ml-auto text-sm bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded-full font-mono">0</span>
              </h3>
              <div id="connected-nodes-list" class="space-y-2">
                <div class="text-center text-zinc-500 py-8 italic">No nodes connected</div>
              </div>
              <button
                onclick="refreshConnectedNodes()"
                class="w-full mt-4 bg-zinc-800 hover:bg-zinc-700 text-white font-bold py-2 rounded-xl transition-colors flex items-center justify-center gap-2"
              >
                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                Refresh
              </button>
            </div>

            <!-- NODE CONFIGURATION -->
            <div class="bg-zinc-900/50 border border-zinc-800 rounded-2xl p-4 md:p-6">
              <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="server-cog" class="w-5 h-5 text-amber-500"></i>
                Node Configuration
              </h3>
              <div class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">HTTP API Port</label>
                    <input type="number" id="config-http-port" class="w-full bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-amber-500 transition-colors" placeholder="3001">
                    <p class="text-[10px] text-zinc-500 mt-1">Default: 3001</p>
                  </div>
                  <div>
                    <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">P2P Port</label>
                    <input type="number" id="config-p2p-port" class="w-full bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-amber-500 transition-colors" placeholder="5001">
                    <p class="text-[10px] text-zinc-500 mt-1">Default: 5001</p>
                  </div>
                </div>
                <div>
                  <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">P2P Host (IP)</label>
                  <input type="text" id="config-p2p-host" class="w-full bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-amber-500 transition-colors" placeholder="localhost">
                </div>
                <div>
                  <label class="block text-xs font-bold text-zinc-500 uppercase mb-1">Seed Peers (Comma Separated)</label>
                  <input type="text" id="config-peers" class="w-full bg-black border border-zinc-800 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-amber-500 transition-colors" placeholder="ws://seed-node.com:5001">
                  <p class="text-[10px] text-zinc-500 mt-1">Initial peers to connect to on startup</p>
                </div>
                <div class="pt-4 flex justify-end">
                  <button onclick="saveNodeConfig()" class="w-full md:w-auto bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 px-6 rounded-xl transition-all active:scale-95 flex items-center justify-center gap-2">
                    <i data-lucide="save" class="w-4 h-4"></i> Save Configuration
                  </button>
                </div>
              </div>
              <p class="text-xs text-rose-500 mt-2 text-center font-bold animate-pulse hidden" id="config-restart-msg">Configuration saved! You MUST restart the node manually for changes to take effect.</p>
            </div>
          </div>
        </div>
        </div>
      </div>
    </main>

    <!-- MODALS -->
    <div
      id="create-wallet-modal"
      class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm"
    >
      <div
        class="bg-zinc-900 border border-zinc-800 p-8 rounded-2xl w-full max-w-md"
      >
        <h3 class="text-xl font-bold text-white mb-4">Create Wallet</h3>
        <input
          id="create-wallet-name"
          type="text"
          placeholder="Wallet Name (e.g. MySavings)"
          class="w-full bg-black border border-zinc-800 rounded-lg px-4 py-3 text-white mb-4 focus:outline-none focus:border-cyan-500"
        />
        <div class="flex gap-3">
          <button
            onclick="closeModal('create-wallet-modal')"
            class="flex-1 py-3 rounded-lg bg-zinc-800 text-white hover:bg-zinc-700"
          >
            Cancel
          </button>
          <button
            onclick="createWallet()"
            class="flex-1 py-3 rounded-lg bg-emerald-500 text-black font-bold hover:bg-emerald-400"
          >
            Create
          </button>
        </div>
      </div>
    </div>

    <!-- IMPORT WALLET MODAL -->
    <div
      id="import-wallet-modal"
      class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50 backdrop-blur-sm"
    >
      <div
        class="bg-zinc-900 border border-zinc-800 p-8 rounded-2xl w-full max-w-md"
      >
        <h3 class="text-xl font-bold text-white mb-4">Import Wallet</h3>
        <input
          id="import-wallet-name"
          type="text"
          placeholder="Wallet Name (e.g. MyRestored)"
          class="w-full bg-black border border-zinc-800 rounded-lg px-4 py-3 text-white mb-4 focus:outline-none focus:border-cyan-500"
        />
        <textarea
          id="import-wallet-mnemonic"
          placeholder="Enter mnemonic phrase here..."
          class="w-full h-24 bg-black border border-zinc-800 rounded-lg px-4 py-3 text-white mb-4 focus:outline-none focus:border-cyan-500 text-sm"
        ></textarea>
        <div class="flex gap-3">
          <button
            onclick="closeModal('import-wallet-modal')"
            class="flex-1 py-3 rounded-lg bg-zinc-800 text-white hover:bg-zinc-700"
          >
            Cancel
          </button>
          <button
            onclick="importWallet()"
            class="flex-1 py-3 rounded-lg bg-blue-500 text-black font-bold hover:bg-blue-400"
          >
            Import
          </button>
        </div>
      </div>
    </div>

    <!-- ALERT MODAL -->
    <div
      id="alert-modal"
      class="fixed inset-0 bg-black/80 hidden items-center justify-center z-50"
    >
      <div
        class="bg-zinc-900 border border-zinc-800 p-6 rounded-2xl w-full max-w-sm text-center"
      >
        <div id="alert-icon" class="mb-4 flex justify-center"></div>
        <h3 id="alert-title" class="text-lg font-bold text-white mb-2"></h3>
        <p id="alert-msg" class="text-zinc-400 text-sm mb-6"></p>
        <button
          onclick="closeModal('alert-modal')"
          class="px-6 py-2 bg-white text-black rounded-lg font-bold hover:bg-zinc-200"
        >
          OK
        </button>
      </div>
    </div>

    <script>
      // CONFIG
      let NODE_API =
        localStorage.getItem("shrimp_node_api") || "http://localhost:3001"; // Default to seed node, but user can change in settings

      // Fix: Use relative path (or current origin) for GUI API to ensure we talk to the correct backend (Node 1 or Node 2)
      // This prevents Node 2 frontend (on port 3004) from sending requests to Node 1 backend (on port 3002)
      let GUI_API = window.location.origin;

      let currentWallet = null;
      let isAutoMining = false;
      let balanceInterval = null;

      // INIT
      document.getElementById("node-url-input").value = NODE_API;
      // --- network ---
      async function updateNetworkStatus() {
        try {
          const res = await fetch(`${GUI_API}/net-peers`);
          const data = await res.json();

          const dot = document.getElementById("network-status-dot");
          const text = document.getElementById("network-status-text");
          const badge = document.getElementById("peer-count-badge");
          const list = document.getElementById("peers-list");
          const miningBtn = document.getElementById("btn-start-mining");

          badge.textContent = data.connected;

          if (data.connected > 0) {
            dot.classList.remove("bg-rose-500");
            dot.classList.add("bg-emerald-500");
            text.textContent = `${data.connected} Peer(s) Connected`;
            miningBtn.disabled = false;
            miningBtn.title = "";
          } else {
            dot.classList.remove("bg-emerald-500");
            dot.classList.add("bg-rose-500");
            text.textContent = "Disconnected (No Peers)";
            miningBtn.disabled = true;
            miningBtn.title =
              "Please connect to a node first (Go to Network tab)";
            if (isAutoMining) stopAutoMining(); // Safety stop
          }

          // Render list
          if (data.peers.length === 0) {
            list.innerHTML = `<div class="text-zinc-500 text-center py-8 italic">No known peers</div>`;
          } else {
            list.innerHTML = data.peers
              .map((peer) => {
                const isConnected = data.sockets.includes(peer);
                return `
                        <div class="flex items-center justify-between p-3 bg-black rounded-xl border border-zinc-800">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 rounded-full ${isConnected ? "bg-emerald-500" : "bg-zinc-600"}"></div>
                                <span class="font-mono text-sm text-zinc-300">${peer}</span>
                            </div>
                            <span class="text-xs ${isConnected ? "text-emerald-500" : "text-zinc-600"}">${isConnected ? "Connected" : "Known"}</span>
                        </div>
                      `;
              })
              .join("");
          }
        } catch (e) {
          console.error("Network status error", e);
        }
      }

      async function connectToPeer() {
        const input = document.getElementById("peer-url-input");
        const peer = input.value.trim();
        if (!peer) return;

        try {
          const res = await fetch(`${GUI_API}/net-connect`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ peer }),
          });
          const data = await res.json();
          showAlert(
            "success",
            "Connecting...",
            `Attempting to connect to ${peer}`,
          );
          setTimeout(updateNetworkStatus, 1000); // Refresh
        } catch (e) {
          showAlert("error", "Connection Failed", e.message);
        }
      }

      // --- init ---
      function init() {
        loadWallets();
        checkMiningStatus();
        updateNetworkStatus();
        loadNodeConfig();
        refreshConnectedNodes(); // Load connected nodes on init
        setInterval(checkMiningStatus, 2000);
        setInterval(updateNetworkStatus, 5000);
        setInterval(refreshConnectedNodes, 10000); // Refresh every 10s
      }
      lucide.createIcons();
      init();

      // --- MOBILE MENU ---
      function toggleMobileMenu() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('-translate-x-full');
      }

      // Close mobile menu when clicking outside
      document.addEventListener('click', (e) => {
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('mobile-menu-btn');
        if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
          sidebar.classList.add('-translate-x-full');
        }
      });

      // --- CONNECTED NODES ---
      async function refreshConnectedNodes() {
        try {
          const res = await fetch(`${GUI_API}/net-peers`);
          const data = await res.json();
          
          const countEl = document.getElementById('connected-count');
          const listEl = document.getElementById('connected-nodes-list');
          
          countEl.textContent = data.connected || 0;
          
          if (!data.peers || data.peers.length === 0) {
            listEl.innerHTML = '<div class=\"text-center text-zinc-500 py-8 italic\">No nodes connected</div>';
          } else {
            listEl.innerHTML = data.peers.map(peer => {
              const isConnected = data.sockets && data.sockets.includes(peer);
              return `
                <div class=\"flex items-center justify-between p-3 bg-black rounded-xl border border-zinc-800\">
                  <div class=\"flex items-center gap-3 flex-1 min-w-0\">
                    <div class=\"w-2 h-2 rounded-full flex-shrink-0 ${isConnected ? 'bg-emerald-500 animate-pulse' : 'bg-zinc-600'}\"></div>
                    <span class=\"font-mono text-xs md:text-sm text-zinc-300 truncate\">${peer}</span>
                  </div>
                  <span class=\"text-xs flex-shrink-0 ml-2 ${isConnected ? 'text-emerald-500' : 'text-zinc-600'} font-bold\">${isConnected ? 'ONLINE' : 'OFFLINE'}</span>
                </div>
              `;
            }).join('');
          }
          
          // Refresh icons
          lucide.createIcons();
        } catch (e) {
          console.error('Failed to refresh connected nodes', e);
          document.getElementById('connected-nodes-list').innerHTML = 
            '<div class=\"text-center text-rose-500 py-8\">Failed to load nodes</div>';
        }
      }

      // --- CONFIGURATION ---
      async function loadNodeConfig() {
          try {
              const res = await fetch(`${GUI_API}/api/config`);
              const config = await res.json();
              
              document.getElementById("config-http-port").value = config.HTTP_PORT || 3001;
              document.getElementById("config-p2p-port").value = config.P2P_PORT || 5001;
              document.getElementById("config-p2p-host").value = config.P2P_HOST || "localhost";
              document.getElementById("config-peers").value = (config.PEERS || []).join(", ");
          } catch(e) {
              console.error("Failed to load config", e);
          }
      }

      async function saveNodeConfig() {
           const httpPort = parseInt(document.getElementById("config-http-port").value);
           const p2pPort = parseInt(document.getElementById("config-p2p-port").value);
           const p2pHost = document.getElementById("config-p2p-host").value;
           const peersVal = document.getElementById("config-peers").value;
           const peers = peersVal ? peersVal.split(",").map(p => p.trim()).filter(p => p) : [];

           const config = {
               HTTP_PORT: httpPort,
               P2P_PORT: p2pPort,
               P2P_HOST: p2pHost,
               PEERS: peers
           };

           try {
               const res = await fetch(`${GUI_API}/api/config`, {
                   method: "POST",
                   headers: { "Content-Type": "application/json" },
                   body: JSON.stringify(config)
               });
               const data = await res.json();
               
               if(data.error) throw new Error(data.error);

               showAlert("success", "Saved", "Configuration saved successfully.");
               document.getElementById("config-restart-msg").classList.remove("hidden");
           } catch(e) {
               showAlert("error", "Save Failed", e.message);
           }
      }

      // TABS
      function switchTab(tabId) {
        document
          .querySelectorAll(".tab-content")
          .forEach((el) => el.classList.add("hidden"));
        document.getElementById("tab-" + tabId).classList.remove("hidden");

        document.querySelectorAll(".nav-item").forEach((el) => {
          el.classList.remove("active", "bg-zinc-900", "text-white");
          el.classList.add("text-zinc-400");
        });
        const navBtn = document.getElementById("nav-" + tabId);
        navBtn.classList.add("active", "bg-zinc-900", "text-white");
        navBtn.classList.remove("text-zinc-400");

        document.getElementById("page-title").textContent =
          tabId.charAt(0).toUpperCase() + tabId.slice(1);
      }

      // WALLETS
      async function loadWallets() {
        try {
          const res = await fetch(`${GUI_API}/api/wallets`);
          const wallets = await res.json();

          const container = document.getElementById("wallet-dropdown");
          const listContainer = document.getElementById(
            "wallet-list-container",
          );

          container.innerHTML = "";
          listContainer.innerHTML = "";

          // Fetch details for each wallet to show address
          for (const name of wallets) {
            const walletRes = await fetch(`${GUI_API}/api/wallets/${name}`);
            const walletData = walletRes.ok ? await walletRes.json() : null;

            // Dropdown Item
            const item = document.createElement("div");
            item.className =
              "px-4 py-2 hover:bg-zinc-800 cursor-pointer text-sm text-zinc-300 hover:text-white transition-colors flex justify-between";
            item.innerHTML = `<span>${name}</span> <span class="text-zinc-600 font-mono text-xs">${walletData ? walletData.publicKey.substring(0, 6) + "..." : "ERROR"}</span>`;
            item.onclick = () => selectWallet(name);
            container.appendChild(item);

            // List Item
            const listItem = document.createElement("div");
            listItem.className =
              "flex items-center justify-between p-4 bg-zinc-900/30 border border-zinc-800 rounded-xl hover:border-zinc-700 group";

            if (walletData) {
              listItem.innerHTML = `
                        <div class="flex items-center gap-4 flex-1 overflow-hidden">
                            <div class="w-10 h-10 rounded-lg bg-zinc-800 flex flex-col items-center justify-center text-zinc-500 font-bold shrink-0">
                                <span class="text-xs uppercase">WAL</span>
                            </div>
                            <div class="flex flex-col overflow-hidden">
                                <span class="text-white font-bold truncate">${name}</span>
                                <div class="flex items-center gap-2 text-zinc-500 text-xs font-mono">
                                    <span class="truncate">${walletData.publicKey}</span>
                                    <button onclick="copyToClipboard('${walletData.publicKey}')" class="hover:text-cyan-400 transition-colors p-1" title="Copy Address">
                                        <i data-lucide="copy" class="w-3 h-3"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2 shrink-0">
                            <button onclick="viewMnemonic('${name}')" class="text-xs bg-zinc-800 text-zinc-400 px-3 py-2 rounded-lg hover:bg-zinc-700 hover:text-white transition-colors font-bold">Mnemonic</button>
                            <button onclick="selectWallet('${name}')" class="text-xs bg-zinc-800 text-zinc-400 px-3 py-2 rounded-lg hover:bg-zinc-700 hover:text-white transition-colors font-bold">Select</button>
                        </div>
                    `;
            } else {
              listItem.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded bg-rose-900/20 flex items-center justify-center text-rose-500 font-bold">!</div>
                            <span class="text-rose-500 font-medium">${name} (Error loading)</span>
                        </div>
                        <button onclick="deleteWallet('${name}')" class="text-xs bg-rose-900/20 text-rose-500 px-3 py-1 rounded hover:bg-rose-900/40 transition-colors">Delete</button>
                    `;
            }
            listContainer.appendChild(listItem);
          }

          lucide.createIcons();

          if (wallets.length > 0 && !currentWallet) {
            selectWallet(wallets[0]);
          }
        } catch (e) {
          log("Error loading wallets: " + e.message);
        }
      }

      async function selectWallet(name) {
        try {
          currentWallet = name;
          document.getElementById("current-wallet-name").textContent = name;
          document.getElementById("wallet-dropdown").classList.add("hidden");

          const res = await fetch(`${GUI_API}/api/wallets/${name}`);
          const data = await res.json();

          document.getElementById("address-display").textContent =
            data.publicKey;
          document.getElementById("miner-address").textContent = data.publicKey;

          // Update the Node API's miner address
          try {
            await fetch(`${NODE_API}/set-miner-address`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ minerAddress: data.publicKey }),
            });
            log(`Miner address updated to wallet: ${name}`);
          } catch (e) {
            log(`Warning: Could not update miner address: ${e.message}`);
          }

          fetchBalance(data.publicKey);

          // Clear intervals to restart them for new wallet if needed
          if (balanceInterval) clearInterval(balanceInterval);
          balanceInterval = setInterval(
            () => fetchBalance(data.publicKey),
            5000,
          ); // Poll balance
        } catch (e) {
          log("Failed to select wallet: " + e.message);
        }
      }

      async function fetchBalance(address) {
        try {
          const res = await fetch(`${NODE_API}/balance?address=${address}`);
          const data = await res.json();
          const elBalance = document.getElementById("balance-display");
          elBalance.textContent = data.balance.toLocaleString();
          elBalance.dataset.balance = data.balance; // Store raw for robust retrieval
          document.getElementById("send-max-balance").textContent =
            data.balance.toLocaleString();
          document
            .getElementById("node-status")
            .classList.replace("text-rose-500", "text-zinc-500");
          document.getElementById("node-status").textContent = "Connected";
        } catch (e) {
          document
            .getElementById("node-status")
            .classList.replace("text-zinc-500", "text-rose-500");
          document.getElementById("node-status").textContent = "Disconnected";
        }
      }

      async function createWallet() {
        const name = document.getElementById("create-wallet-name").value;
        if (!name) return;

        try {
          const res = await fetch(`${GUI_API}/api/wallets/create`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name }),
          });
          const data = await res.json();
          if (data.error) throw new Error(data.error);

          closeModal("create-wallet-modal");
          await loadWallets();
          selectWallet(name);
          showAlert(
            "success",
            "Wallet Created",
            "Please backup your mnemonic manually (check server logs).",
          );
        } catch (e) {
          showAlert("error", "Error", e.message);
        }
      }

      async function importWallet() {
        const name = document.getElementById("import-wallet-name").value;
        const mnemonic = document.getElementById(
          "import-wallet-mnemonic",
        ).value;
        if (!name || !mnemonic) return;

        try {
          const res = await fetch(`${GUI_API}/api/wallets/import`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, mnemonic }),
          });
          const data = await res.json();
          if (data.error) throw new Error(data.error);

          closeModal("import-wallet-modal");
          await loadWallets();
          selectWallet(name);
          showAlert(
            "success",
            "Wallet Imported",
            "Wallet restored successfully.",
          );
        } catch (error) {
          showAlert("error", "Import Failed", error.message);
        }
      }

      async function viewMnemonic(name) {
        try {
          const res = await fetch(`${GUI_API}/api/wallets/${name}/mnemonic`);
          const data = await res.json();
          if (data.error) throw new Error(data.error);

          // Show in a prompt for now, or a modal if we had one.
          // Prompt is simple and copyable.
          prompt(
            `Secret Recovery Phrase for "${name}":\n(Do not share this with anyone!)`,
            data.mnemonic,
          );
        } catch (e) {
          showAlert("error", "Error", e.message);
        }
      }

      // --- mining ---
      async function sendTransaction() {
        if (!currentWallet)
          return showAlert("error", "Error", "No wallet selected");

        const recipient = document.getElementById("send-recipient").value;
        let amountVal = document.getElementById("send-amount").value;
        let feeVal = document.getElementById("send-fee").value;

        // Fix: Replace comma with dot for decimal support
        amountVal = amountVal.replace(/,/g, ".");
        feeVal = feeVal.replace(/,/g, ".");

        if (!recipient || !amountVal)
          return showAlert("error", "Error", "Please fill all fields");

        if (isNaN(amountVal) || parseFloat(amountVal) <= 0) {
          return showAlert("error", "Error", "Invalid amount");
        }
        
        const fee = parseFloat(feeVal) || 1;
        if (fee < 1) {
            return showAlert("error", "Error", "Fee must be at least 1");
        }

        const btnText = document.getElementById("send-btn-text");
        const spinner = document.getElementById("send-spinner");

        btnText.classList.add("hidden");
        spinner.classList.remove("hidden");

        try {
          // 1. Get current balance from UI (trusted by lightweight GUI server)
          // Use data attribute for raw value to avoid locale formatting bugs
          const currentBalance = parseFloat(
            document.getElementById("balance-display").dataset.balance || "0",
          );

          // 2. Sign Transaction (Bridge to Backend)
          const signRes = await fetch(`${GUI_API}/api/sign-transaction`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              walletName: currentWallet,
              recipient,
              amount: amountVal,
              fee,
              currentBalance,
            }),
          });
          const signData = await signRes.json();
          if (signData.error) throw new Error(signData.error);

          // 3. Broadcast to Node
          const broadRes = await fetch(`${NODE_API}/transact`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ transaction: signData.transaction }),
          });
          const broadData = await broadRes.json();

          if (broadData.type === "error") throw new Error(broadData.message);

          showAlert(
            "success",
            "Transaction Sent!",
            `Sent ${amountVal} SHRIMP (+${fee} Fee) to ${recipient.substring(0, 8)}...`,
          );
          document.getElementById("send-recipient").value = "";
          document.getElementById("send-amount").value = "";
          document.getElementById("send-fee").value = "1";
          log(`Sent ${amountVal} SHRIMP (+${fee} Fee) to ${recipient}`);
        } catch (e) {
          showAlert("error", "Transaction Failed", e.message);
        } finally {
          btnText.classList.remove("hidden");
          spinner.classList.add("hidden");
        }
      }

      // MINER
      async function checkMiningStatus() {
        try {
          const res = await fetch(`${NODE_API}/miner/status`);
          const data = await res.json();
          updateMinerUI(data.isAutoMining);
        } catch (e) {}
      }

      function updateMinerUI(active) {
        isAutoMining = active;
        const bg = document.getElementById("miner-icon-bg");
        const icon = document.getElementById("miner-icon");
        const statusBox = document.getElementById("miner-status-text");
        const btn = document.getElementById("miner-toggle-btn");

        if (active) {
          bg.classList.replace("bg-zinc-800", "bg-amber-500/20");
          icon.classList.replace("text-zinc-500", "text-amber-500");
          icon.classList.add("animate-pulse");
          statusBox.textContent = "AUTO-MINING ACTIVE";
          statusBox.className =
            "text-amber-500 mb-8 font-mono font-bold animate-pulse";
          btn.textContent = "Stop Auto-Mining";
          btn.classList.add("bg-rose-600", "border-rose-500");
          btn.classList.remove("bg-zinc-800", "border-zinc-700");
        } else {
          bg.classList.replace("bg-amber-500/20", "bg-zinc-800");
          icon.classList.replace("text-amber-500", "text-zinc-500");
          icon.classList.remove("animate-pulse");
          statusBox.textContent = "IDLE";
          statusBox.className = "text-zinc-500 mb-8 font-mono";
          btn.textContent = "Start Auto-Mining";
          btn.classList.remove("bg-rose-600", "border-rose-500");
          btn.classList.add("bg-zinc-800", "border-zinc-700");
        }
      }

      async function toggleAutoMining() {
        try {
          const endpoint = isAutoMining ? "/miner/stop" : "/miner/start";
          const res = await fetch(`${NODE_API}${endpoint}`, { method: "POST" });
          const data = await res.json();
          updateMinerUI(data.isAutoMining);
          log(data.message);
        } catch (e) {
          showAlert("error", "Error", e.message);
        }
      }

      async function mineBlockOnce() {
        try {
          const res = await fetch(`${NODE_API}/mine`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              minerAddress:
                document.getElementById("miner-address").textContent,
            }),
          });
          log("Manual mining started...");
          showAlert(
            "success",
            "Mining Started",
            "Block mining initiated manually.",
          );
        } catch (e) {
          showAlert("error", "Error", e.message);
        }
      }

      // UTILS
      function log(msg) {
        const container = document.getElementById("logs-container");
        // Remove initial placeholder if it matches exactly
        if (
          container.firstElementChild &&
          container.firstElementChild.textContent ===
            "Waiting for connection..."
        ) {
          container.innerHTML = "";
        }

        const div = document.createElement("div");
        const time = new Date().toLocaleTimeString();
        div.textContent = `[${time}] ${msg}`;
        container.prepend(div);
      }

      // WEBSOCKET (P2P Logs)
      let ws;
      function connectWebSocket() {
        try {
          // Infer P2P URL from NODE_API (Assuming 3001 -> 5001 or just standard 5001)
          // If NODE_API is http://192.168.100.173:3001, we want ws://192.168.100.173:5001
          const url = new URL(NODE_API);
          const p2pPort = 5001; // Default
          const wsUrl = `ws://${url.hostname}:${p2pPort}`;

          log(`Connecting to P2P Node at ${wsUrl}...`);

          ws = new WebSocket(wsUrl);

          ws.onopen = () => {
            log("‚úÖ Connected to P2P Network!");
            document.getElementById("node-status").textContent =
              "Connected (P2P)";
            document
              .getElementById("node-status")
              .classList.replace("text-zinc-500", "text-emerald-500");
            document
              .getElementById("node-status")
              .classList.remove("animate-pulse");
          };

          ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              switch (data.type) {
                case "CHAIN":
                  const chain = data.chain;
                  const lastBlock = chain[chain.length - 1];
                  log(
                    `üì¶ New Block Received! Height: ${
                      chain.length
                    }, Hash: ${lastBlock.hash.substring(0, 10)}...`,
                  );
                  // Refresh balance as it might have changed
                  if (currentWallet) {
                    // Re-fetch wallet details to get address again just in case, or just use stored one
                    const addr =
                      document.getElementById("address-display").textContent;
                    if (addr && addr !== "...") fetchBalance(addr);
                  }
                  break;
                case "TRANSACTION":
                  log(
                    `üí∏ New Transaction: ${
                      data.transaction.input.amount
                    } SHRIMP from ${data.transaction.input.address.substring(
                      0,
                      8,
                    )}...`,
                  );
                  break;
                case "CLEAR_TRANSACTIONS":
                  log("üßπ Transaction Pool Cleared");
                  break;
              }
            } catch (e) {
              // Ignore parse errors
            }
          };

          ws.onclose = () => {
            log("‚ùå P2P Connection Lost. Retrying in 5s...");
            document.getElementById("node-status").textContent =
              "Disconnected (P2P)";
            document
              .getElementById("node-status")
              .classList.replace("text-emerald-500", "text-rose-500");
            setTimeout(connectWebSocket, 5000);
          };

          ws.onerror = (err) => {
            // log('WebSocket Error');
          };
        } catch (e) {
          log("Failed to setup WebSocket: " + e.message);
        }
      }

      // Start WS
      connectWebSocket();

      function showModal(id) {
        document.getElementById(id).classList.remove("hidden");
        document.getElementById(id).classList.add("flex");
      }
      function closeModal(id) {
        document.getElementById(id).classList.add("hidden");
        document.getElementById(id).classList.remove("flex");
      }

      function showAlert(type, title, msg) {
        document.getElementById("alert-title").textContent = title;
        document.getElementById("alert-msg").textContent = msg;

        const icon = document.getElementById("alert-icon");
        if (type === "success")
          icon.innerHTML =
            '<i data-lucide="check-circle" class="w-12 h-12 text-emerald-500"></i>';
        else
          icon.innerHTML =
            '<i data-lucide="alert-circle" class="w-12 h-12 text-rose-500"></i>';

        showModal("alert-modal");
      }

      async function copyAddress() {
        const addr = document.getElementById("address-display").textContent;
        await copyToClipboard(addr);
      }

      async function copyToClipboard(text) {
        if (!text || text === "...") return;

        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
          } else {
            // Fallback for HTTP
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
              document.execCommand("copy");
            } catch (err) {
              console.error("Fallback: Oops, unable to copy", err);
              throw new Error("Copy failed");
            }
            document.body.removeChild(textArea);
          }
          log("Copied: " + text.substring(0, 8) + "...");
          showAlert("success", "Copied!", "Address copied to clipboard.");
        } catch (err) {
          log("Failed to copy: " + err);
          showAlert(
            "error",
            "Copy Failed",
            "Could not copy text to clipboard.",
          );
        }
      }

      function saveSettings() {
        const url = document.getElementById("node-url-input").value;
        localStorage.setItem("shrimp_node_api", url);
        NODE_API = url;
        showAlert("success", "Saved", "Settings updated.");
        checkMiningStatus();
        // Reconnect WS
        if (ws) ws.close();
        connectWebSocket();
      }

      // Toggle Wallet Dropdown
      document.getElementById("wallet-select-btn").onclick = () => {
        document.getElementById("wallet-dropdown").classList.toggle("hidden");
      };
    </script>
  </body>
</html>
